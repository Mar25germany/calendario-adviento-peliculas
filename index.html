<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üéÑ Calendario de Cine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@400;700&family=Outfit:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-gradient-start: #0f172a; 
            --bg-gradient-mid: #1e1b4b;   
            --bg-gradient-end: #312e81;   
            --glass-bg: rgba(255, 255, 255, 0.12);
            --glass-border: rgba(255, 255, 255, 0.3);
            --accent-gold: #fbbf24;
            --accent-red: #ef4444;
            --text-main: #f3f4f6;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(180deg, var(--bg-gradient-start) 0%, var(--bg-gradient-mid) 50%, var(--bg-gradient-end) 100%);
            background-attachment: fixed;
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
            margin: 0; padding: 0;
            /* Prevenir rebote en iOS */
            overscroll-behavior-y: none;
        }

        h1.main-title, .christmas-font { font-family: 'Mountains of Christmas', cursive; letter-spacing: 1px; }

        /* --- UI COMPONENTS --- */
        .glass-panel {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-top: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 24px; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); 
            color: var(--text-main);
        }

        .input-clean {
            width: 100%; padding: 16px; color: #fff; background: rgba(0, 0, 0, 0.4); 
            border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.2); outline: none; font-weight: 500; transition: all 0.3s ease;
        }
        .input-clean:focus { background: rgba(0, 0, 0, 0.6); border-color: var(--accent-gold); box-shadow: 0 0 15px rgba(251, 191, 36, 0.2); }
        .input-clean::placeholder { color: #9ca3af; font-weight: 400; }

        .btn-action {
            background: linear-gradient(135deg, #fbbf24, #d97706); color: #1e1b4b; border-radius: 12px; font-weight: 800; transition: transform 0.2s, box-shadow 0.2s, filter 0.2s; box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3); text-transform: uppercase; letter-spacing: 1px; border: none;
        }
        .btn-action:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(251, 191, 36, 0.5); filter: brightness(1.1); }
        .btn-action:active { transform: translateY(0); }

        .btn-secondary { background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255,255,255,0.2); font-weight: 600; }
        .btn-secondary:hover { background: rgba(255, 255, 255, 0.2); }

        .tab-btn { width: 50%; padding: 12px; font-weight: bold; text-transform: uppercase; font-size: 0.85rem; border-radius: 12px; transition: all 0.3s; }
        .tab-active { background: var(--accent-gold); color: #312e81; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .tab-inactive { background: transparent; color: #9ca3af; }
        .tab-inactive:hover { background: rgba(255,255,255,0.05); color: white; }

        /* --- CARRUSEL ANIMADO --- */
        .carousel-container { overflow: hidden; position: relative; width: 100%; height: 340px; display: flex; align-items: center; mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent); -webkit-mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent); }
        .carousel-track { display: flex; gap: 25px; animation: scroll-horizontal 40s linear infinite; height: 100%; padding: 20px 0; align-items: center; }
        .carousel-container:hover .carousel-track { animation-play-state: paused; }
        @keyframes scroll-horizontal { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }

        /* Animaci√≥n suave de "mecerse" para los posters */
        @keyframes gentle-sway {
            0% { transform: scale(1.4) translateY(-20px) rotate(0deg); }
            25% { transform: scale(1.4) translateY(-20px) rotate(-2deg); }
            50% { transform: scale(1.4) translateY(-20px) rotate(0deg); }
            75% { transform: scale(1.4) translateY(-20px) rotate(2deg); }
            100% { transform: scale(1.4) translateY(-20px) rotate(0deg); }
        }

        .movie-card-preview { 
            background: #000; border-radius: 8px; overflow: hidden; box-shadow: 0 8px 20px rgba(0,0,0,0.6); transition: all 0.3s ease; flex-shrink: 0; position: relative; height: 270px; width: 180px; border: 1px solid rgba(255,255,255,0.2); 
        }
        .movie-card-preview:hover { 
            animation: gentle-sway 3s ease-in-out infinite; /* M√°s lento y suave */
            z-index: 50; border-color: var(--accent-gold); box-shadow: 0 30px 60px rgba(0,0,0,0.9), 0 0 40px rgba(251, 191, 36, 0.4); 
        }
        .movie-card-preview img { width: 100%; height: 100%; object-fit: cover; }

        /* --- AVATAR INTERACTIVO --- */
        #avatar-display { transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); cursor: pointer; position: relative; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        #avatar-display:hover { transform: scale(1.6); box-shadow: 0 0 25px rgba(251, 191, 36, 0.8); border-color: var(--accent-gold); z-index: 100; }

        .avatar-gallery-item { position: relative; transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease; z-index: 1; }
        .avatar-gallery-item:hover { transform: scale(1.4); z-index: 50; border-color: var(--accent-gold); box-shadow: 0 0 20px rgba(251, 191, 36, 0.6); }

        /* --- CALENDARIO GRID --- */
        .calendar-cell { aspect-ratio: 1/1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 1rem; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.03); backdrop-filter: blur(5px); }
        .calendar-cell.active-day { background: rgba(251, 191, 36, 0.1); border-color: rgba(251, 191, 36, 0.3); cursor: pointer; }
        .calendar-cell.active-day:hover { transform: translateY(-5px) scale(1.05); background: rgba(251, 191, 36, 0.2); box-shadow: 0 10px 20px rgba(0,0,0,0.3), 0 0 15px rgba(251, 191, 36, 0.2); border-color: var(--accent-gold); }
        .calendar-cell.locked-day { opacity: 0.5; background: rgba(0,0,0,0.2); border-color: transparent; }

        /* Efecto Flip para ganadoras */
        .flip-container { perspective: 1000px; cursor: pointer; border: none; background: transparent; }
        .flip-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.8s; transform-style: preserve-3d; border-radius: 1rem; }
        .flip-container:hover .flip-inner { transform: rotateY(180deg); } 
        .flip-front, .flip-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 1rem; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 1px solid var(--accent-gold); }
        .flip-front { background-size: cover; background-position: center; }
        .flip-back { background: var(--accent-gold); color: #312e81; transform: rotateY(180deg); flex-direction: column; font-weight: bold; }

        /* --- MODAL Y RESPONSIVIDAD --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 200; display: flex; align-items: center; justify-content: center; padding: 1rem; backdrop-filter: blur(8px); }
        .hidden { display: none !important; }
        
        /* Header responsivo: Se achica en m√≥viles */
        .user-header { position: fixed; top: 20px; right: 20px; display: flex; align-items: center; gap: 12px; background: rgba(0, 0, 0, 0.6); padding: 6px 16px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); z-index: 150; box-shadow: 0 4px 20px rgba(0,0,0,0.4); transition: all 0.3s ease; }
        @media (max-width: 640px) {
            .user-header { top: 10px; right: 10px; padding: 4px 12px; transform: scale(0.9); transform-origin: top right; }
            .user-header h2 { max-width: 80px; font-size: 0.8rem; }
        }

        /* Estilo para las im√°genes de votaci√≥n (GRANDE y ADAPTABLE) */
        #duel-modal .movie-card-image-wrapper {
            position: relative; overflow: hidden; border-radius: 1rem; 
            height: 450px; /* Desktop: Alto */
            background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; 
            border: 2px solid rgba(255, 255, 255, 0.15); box-shadow: inset 0 0 20px rgba(0,0,0,0.5); 
            transition: all 0.3s ease;
        }
        #duel-modal .movie-card-image-wrapper img { width: 100%; height: 100%; object-fit: contain; transition: transform 0.5s ease; }
        #duel-modal .movie-card-image-wrapper:hover img { transform: scale(1.05); opacity: 0.95; }
        #duel-modal .movie-card-container:hover .movie-card-image-wrapper { border-color: var(--accent-gold); box-shadow: 0 0 25px rgba(251, 191, 36, 0.4), inset 0 0 10px rgba(0,0,0,0.8); }

        @media (max-width: 768px) {
            #duel-modal .movie-card-image-wrapper { height: 280px; /* M√≥vil: Altura controlada */ }
            h1.main-title { font-size: 2.5rem; }
        }

        /* Utils Decorativos */
        .snowflake { position: fixed; top: -10px; z-index: 1; color: rgba(255,255,255,0.3); pointer-events: none; animation: snowfall linear infinite; }
        @keyframes snowfall { 0% { transform: translateY(0); opacity: 0.8; } 100% { transform: translateY(100vh); opacity: 0; } }

        .lightrope { text-align: center; white-space: nowrap; overflow: visible; position: fixed; z-index: 100; top: -15px; width: 100%; display: flex; justify-content: center; pointer-events: none; padding: 0; margin: 0; }
        .lightrope li { position: relative; animation-fill-mode: both; animation-iteration-count: infinite; list-style: none; margin: 0 20px; width: 12px; height: 22px; border-radius: 50%; background: rgba(255,255,255,0.2); z-index: 2; }
        .lightrope li:before { content: ""; position: absolute; background: #222; width: 10px; height: 8px; border-radius: 3px; top: -2px; left: 1px; z-index: 3; }
        .lightrope li:after { content: ""; top: -10px; left: 10px; position: absolute; width: 40px; height: 16px; border-bottom: solid rgba(255,255,255,0.2) 2px; border-radius: 50%; z-index: -1; }
        .lightrope li:last-child:after { content: none; }
        .lightrope li:nth-child(3n+1) { background: #ffdb00; box-shadow: 0px 5px 25px 3px rgba(255, 219, 0, 0.4); animation: flash-1 2s infinite; }
        .lightrope li:nth-child(3n+2) { background: #00ff22; box-shadow: 0px 5px 25px 3px rgba(0, 255, 34, 0.4); animation: flash-2 2.5s infinite; }
        .lightrope li:nth-child(3n+3) { background: #ff0033; box-shadow: 0px 5px 25px 3px rgba(255, 0, 51, 0.4); animation: flash-3 3s infinite; }
        @keyframes flash-1 { 0%, 100% { opacity: 1; transform: scale(1.1); } 50% { opacity: 0.3; transform: scale(1); } }
        @keyframes flash-2 { 0%, 100% { opacity: 1; transform: scale(1.1); } 50% { opacity: 0.3; transform: scale(1); } }
        @keyframes flash-3 { 0%, 100% { opacity: 1; transform: scale(1.1); } 50% { opacity: 0.3; transform: scale(1); } }
    </style>
</head>
<body class="relative">

    <ul class="lightrope"><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li></ul>
    <div id="snow-container"></div>
    
    <div id="config-error-overlay" class="hidden modal-overlay">
        <div class="glass-panel p-8 max-w-md text-center">
            <h2 class="text-2xl font-bold mb-2 text-red-400">Falta Configuraci√≥n</h2>
            <p class="text-gray-300">Edita el archivo y pega tu <b>API KEY</b>.</p>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 relative z-20 flex flex-col items-center min-h-screen">
        <header class="text-center mb-10 mt-16 relative z-30 w-full">
            <div class="inline-block relative">
                <div class="absolute inset-0 bg-yellow-500 blur-[60px] opacity-20 rounded-full"></div>
                <h1 class="main-title text-5xl md:text-7xl text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 via-yellow-400 to-yellow-600 drop-shadow-sm leading-tight pb-2 relative z-10">Calendario de Cine</h1>
            </div>
            <p class="text-indigo-200 mt-2 text-lg font-light tracking-widest uppercase">La Magia del Adviento</p>
        </header>

        <!-- AUTH -->
        <div id="auth-view" class="w-full max-w-md glass-panel p-8 relative z-30">
            <div class="bg-black/20 p-1 rounded-xl mb-8 flex border border-white/5">
                <button onclick="toggleAuth('login')" id="tab-login" class="tab-btn tab-active">Ingresar</button>
                <button onclick="toggleAuth('register')" id="tab-register" class="tab-btn tab-inactive">Registro</button>
            </div>
            <div class="text-center mb-8">
                <p class="text-3xl font-bold text-yellow-400 christmas-font flex justify-center items-center gap-2">
                    <span id="auth-greeting-icon">üé¨</span> <span id="auth-greeting-text">¬°Hola de nuevo!</span>
                </p>
            </div>
            <form id="auth-form" class="space-y-5">
                <div id="name-field" class="hidden"><input type="text" id="full-name" placeholder="Tu Nombre" class="input-clean"></div>
                <input type="email" id="email" placeholder="Correo electr√≥nico" class="input-clean" required>
                <div class="relative">
                    <input type="password" id="password" placeholder="Contrase√±a" class="input-clean" required>
                    <button type="button" onclick="togglePassword()" class="absolute right-4 top-4 text-gray-400 hover:text-white transition"><i class="fas fa-eye" id="eye-icon"></i></button>
                </div>
                <div id="auth-msg" class="text-center text-sm text-red-400 font-bold hidden bg-red-900/20 p-2 rounded-lg border border-red-500/20"></div>
                <button type="submit" id="submit-btn" class="w-full btn-action p-4 mt-6 text-lg tracking-widest flex items-center justify-center gap-2 shadow-lg"><span>ENTRAR</span></button>
            </form>
        </div>

        <!-- APP -->
        <div id="app-view" class="hidden w-full max-w-7xl relative z-30"> 
            <div class="user-header">
                <div class="flex items-center gap-3">
                    <div id="avatar-display" class="w-10 h-10 rounded-full bg-indigo-900 flex items-center justify-center border border-indigo-500/50"><span class="text-lg">üë§</span></div>
                    <h2 id="welcome-msg" class="text-sm text-indigo-100 font-bold truncate max-w-[100px]">Hola!</h2>
                </div>
                <div class="h-4 w-[1px] bg-white/20 mx-2"></div>
                <div class="flex gap-1">
                    <button onclick="openAvatarModal()" class="w-8 h-8 rounded-full hover:bg-white/10 text-yellow-400 flex items-center justify-center transition"><i class="fas fa-pencil-alt text-xs"></i></button>
                    <button onclick="logout()" class="w-8 h-8 rounded-full hover:bg-white/10 text-red-400 flex items-center justify-center transition"><i class="fas fa-power-off text-xs"></i></button>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row justify-center gap-6 mb-10 mt-4 md:mt-0">
                <button onclick="showSection('calendar')" class="btn-action px-8 py-3 w-full sm:w-auto flex items-center justify-center gap-2"><i class="fas fa-calendar-alt"></i> Calendario</button>
                <button onclick="showSection('upload')" class="btn-secondary px-8 py-3 rounded-xl transition w-full sm:w-auto flex items-center justify-center gap-2"><i class="fas fa-film"></i> Subir Peli</button>
            </div>

            <div id="section-calendar" class="w-full max-w-5xl mx-auto">
                <div class="flex justify-between items-end mb-6 px-2">
                    <h2 class="text-4xl md:text-6xl christmas-font text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-400">Diciembre</h2>
                    <span class="text-indigo-300 text-sm font-bold uppercase tracking-widest mb-2">2025</span>
                </div>
                <div class="grid grid-cols-7 gap-1 md:gap-4 mb-4 text-center">
                    <div class="font-bold text-indigo-400 text-xs md:text-sm tracking-widest">LUN</div><div class="font-bold text-indigo-400 text-xs md:text-sm tracking-widest">MAR</div><div class="font-bold text-indigo-400 text-xs md:text-sm tracking-widest">MI√â</div><div class="font-bold text-indigo-400 text-xs md:text-sm tracking-widest">JUE</div><div class="font-bold text-indigo-400 text-xs md:text-sm tracking-widest">VIE</div><div class="font-bold text-indigo-400 text-xs md:text-sm tracking-widest">S√ÅB</div><div class="font-bold text-red-400 text-xs md:text-sm tracking-widest">DOM</div>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-2 md:gap-4 lg:gap-5"></div>
            </div>

            <div id="section-upload" class="hidden w-full mx-auto animate-fade-in">
                <div class="flex flex-col gap-8 items-center">
                    <div class="glass-panel p-0 overflow-hidden h-96 w-full relative flex flex-col items-center justify-center mb-4">
                        <div class="absolute top-0 left-0 w-full p-4 z-20 bg-gradient-to-b from-black/80 to-transparent">
                            <h3 class="text-2xl christmas-font text-center text-yellow-400 flex items-center justify-center gap-2"><span>‚ú®</span> En Cartelera <span>‚ú®</span></h3>
                        </div>
                        <div class="carousel-container mt-8"><div id="carousel-track" class="carousel-track"></div></div>
                    </div>
                    <div class="glass-panel p-8 w-full max-w-lg border border-yellow-500/20 shadow-[0_0_30px_rgba(251,191,36,0.1)]">
                        <h3 class="text-3xl christmas-font text-center mb-2 text-white">Nueva Funci√≥n</h3>
                        <p class="text-center text-indigo-300 text-sm mb-8">A√±ade una pel√≠cula</p>
                        <form id="upload-form" class="space-y-6">
                            <input type="text" id="movie-title" placeholder="T√≠tulo" class="input-clean" required>
                            <div class="border-2 border-dashed border-indigo-500/30 bg-indigo-900/20 rounded-xl p-8 text-center cursor-pointer hover:bg-indigo-900/40 hover:border-yellow-400/50 transition relative group">
                                <i class="fas fa-cloud-upload-alt text-4xl mb-3 text-indigo-400 group-hover:text-yellow-400 transition"></i>
                                <p class="text-sm text-indigo-300">Subir portada</p>
                                <input type="file" id="movie-file" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" required>
                            </div>
                            <div id="upload-msg" class="text-center text-sm font-bold min-h-[20px]"></div>
                            <button type="submit" class="w-full btn-action p-4 text-white shadow-lg">GUARDAR</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALES -->
    <div id="avatar-modal" class="hidden modal-overlay">
        <div class="glass-panel p-8 max-w-sm w-full text-center relative border border-white/20">
            <button onclick="document.getElementById('avatar-modal').classList.add('hidden')" class="absolute top-4 right-4 text-2xl text-gray-400 hover:text-white">&times;</button>
            <h3 class="text-3xl christmas-font mb-6 text-yellow-400">Tu Personaje</h3>
            
            <div id="avatar-grid" class="grid grid-cols-3 gap-6 justify-items-center mb-6 max-h-[300px] overflow-y-auto p-4"></div>
            
            <div class="border-t border-white/10 pt-4">
                <p class="text-sm text-gray-400 mb-3">O sube tu foto:</p>
                <div class="flex gap-2">
                    <input type="file" id="custom-avatar-input" accept="image/*" class="hidden" onchange="uploadCustomAvatar()">
                    <button onclick="document.getElementById('custom-avatar-input').click()" class="w-full py-2 btn-secondary rounded-lg text-sm"><i class="fas fa-upload mr-2"></i> Subir Archivo</button>
                </div>
                <div id="avatar-upload-msg" class="text-xs text-center mt-2 h-4 text-yellow-400"></div>
            </div>
        </div>
    </div>

    <div id="duel-modal" class="hidden modal-overlay">
        <div class="glass-panel p-6 md:p-10 max-w-5xl w-full mx-4 relative flex flex-col items-center max-h-[90vh] overflow-y-auto border border-yellow-500/30 shadow-[0_0_50px_rgba(0,0,0,0.5)]">
            <button onclick="closeDuel()" class="absolute top-4 right-4 text-3xl text-gray-400 hover:text-white z-50">&times;</button>
            <h2 class="text-4xl md:text-5xl christmas-font text-yellow-400 mb-2 text-center drop-shadow-md">D√≠a <span id="duel-day-number"></span></h2>
            <div class="w-24 h-1 bg-gradient-to-r from-transparent via-yellow-500 to-transparent mb-8"></div>
            <div id="view-already-voted" class="hidden flex flex-col items-center py-8 w-full">
                <div class="text-6xl mb-4 p-4 rounded-full bg-green-500/20 border border-green-500 text-green-400">‚úÖ</div>
                <h3 class="text-2xl font-bold text-white mb-2 text-center">¬°Voto registrado!</h3>
                <p class="text-indigo-200 mb-8 text-center px-4">Ya elegiste pel√≠cula.</p>
                <button onclick="showVotingOptions()" class="px-8 py-3 bg-indigo-600 text-white rounded-full font-bold hover:bg-indigo-500 transition shadow-lg">üîÑ Cambiar voto</button>
            </div>
            <div id="view-voting-options" class="w-full">
                <p class="text-indigo-200 mb-8 text-xl text-center font-light">Elige la ganadora</p>
                <div class="w-full grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12 relative">
                    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-20 md:flex hidden">
                        <div class="w-16 h-16 rounded-full text-xl font-bold bg-black text-yellow-500 border-2 border-yellow-500 shadow-[0_0_20px_rgba(251,191,36,0.4)] flex items-center justify-center italic">VS</div>
                    </div>
                    
                    <!-- Opci√≥n A -->
                    <div id="movie-a-container" class="cursor-pointer group relative p-4 rounded-2xl bg-black/40 hover:bg-indigo-900/40 transition border border-white/5 hover:border-yellow-400/50 movie-card-container" onclick="voteFor('A')">
                        <div class="movie-card-image-wrapper">
                            <img id="img-a" src="" alt="Pelicula A">
                        </div>
                        <div class="mt-4 text-center relative z-10"><h3 id="title-a" class="text-2xl font-bold text-white group-hover:text-yellow-400 transition truncate">A</h3></div>
                    </div>

                    <div class="flex md:hidden justify-center items-center py-2"><div class="w-12 h-12 rounded-full text-lg font-bold bg-black text-yellow-500 border border-yellow-500 flex items-center justify-center">VS</div></div>
                    
                    <!-- Opci√≥n B -->
                    <div id="movie-b-container" class="cursor-pointer group relative p-4 rounded-2xl bg-black/40 hover:bg-indigo-900/40 transition border border-white/5 hover:border-yellow-400/50 movie-card-container" onclick="voteFor('B')">
                         <div class="movie-card-image-wrapper">
                            <img id="img-b" src="" alt="Pelicula B">
                        </div>
                        <div class="mt-4 text-center relative z-10"><h3 id="title-b" class="text-2xl font-bold text-white group-hover:text-yellow-400 transition truncate">B</h3></div>
                    </div>
                </div>
                <div id="vote-message" class="mt-8 font-bold text-xl h-8 text-center text-yellow-400"></div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://gxmffvomofibtayteooa.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd4bWZmdm9tb2ZpYnRheXRlb29hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3ODEzMzgsImV4cCI6MjA4MDM1NzMzOH0.fV7q5itF79PUbH6CRW0fALE43cFS23-_klNlTdnIfNM';

        let supabase, currentUser, isLogin = true;

        try {
            if (SUPABASE_KEY.length < 10) throw "No Key";
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            initApp();
        } catch { document.getElementById('config-error-overlay').classList.remove('hidden'); }

        function initApp() {
            createSnow();
            supabase.auth.getSession().then(({ data: { session } }) => {
                if (session) handleLogin(session.user);
            });
            // Habilitar Websockets Realtime
            setupRealtime();
        }

        // --- REALTIME: Conexi√≥n Websocket Instant√°nea ---
        function setupRealtime() {
            console.log("Iniciando conexi√≥n Websocket...");
            supabase.channel('custom-all-channel')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'calendar_days' }, (payload) => {
                console.log("Cambio en Calendario recibido!", payload);
                loadCalendar();
            })
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'votes' }, (payload) => {
                console.log("Nuevo voto recibido!", payload);
                loadCalendar();
            })
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'votes' }, (payload) => {
                console.log("Voto actualizado!", payload);
                loadCalendar();
            })
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'movies' }, (payload) => {
                console.log("Nueva pel√≠cula subida!", payload);
                loadUploadedMovies();
            })
            .subscribe((status) => {
                if (status === 'SUBSCRIBED') {
                    console.log("‚úÖ Conectado a Supabase Realtime (Websockets activos)");
                }
            });
        }

        window.toggleAuth = (mode) => {
            isLogin = mode === 'login';
            document.getElementById('name-field').classList.toggle('hidden', isLogin);
            document.getElementById('auth-greeting-text').textContent = isLogin ? "¬°Hola de nuevo!" : "¬°√önete al club!";
            document.getElementById('submit-btn').innerHTML = isLogin ? "<span>ENTRAR</span>" : "<span>REGISTRARSE</span>";
            document.getElementById('tab-login').className = isLogin ? "tab-btn tab-active" : "tab-btn tab-inactive";
            document.getElementById('tab-register').className = !isLogin ? "tab-btn tab-active" : "tab-btn tab-inactive";
            document.getElementById('auth-msg').classList.add('hidden');
        }

        window.togglePassword = function() {
            const input = document.getElementById('password');
            input.type = input.type === "password" ? "text" : "password";
        }

        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value.trim();
            const pass = document.getElementById('password').value.trim();
            const name = document.getElementById('full-name').value.trim();
            const msg = document.getElementById('auth-msg');
            const btn = document.getElementById('submit-btn');

            msg.classList.add('hidden'); btn.classList.add('opacity-50');
            
            try {
                if (isLogin) {
                    const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
                    if (error) throw error;
                    handleLogin(data.user);
                } else {
                    if(!name) throw new Error("¬°Por favor dinos tu nombre!");
                    const { error } = await supabase.auth.signUp({ email, password: pass, options: { data: { full_name: name } } });
                    if (error) throw error;
                    alert("¬°Registro exitoso! Revisa tu correo.");
                    toggleAuth('login');
                }
            } catch (err) { 
                console.error(err); msg.textContent = err.message.includes("Invalid") ? "Credenciales incorrectas" : err.message; msg.classList.remove('hidden'); 
            } finally { btn.classList.remove('opacity-50'); }
        });

        async function handleLogin(user) {
            currentUser = user;
            document.getElementById('auth-view').classList.add('hidden');
            document.getElementById('app-view').classList.remove('hidden');
            refreshProfile();
            loadCalendar();
            loadUploadedMovies();
        }

        async function refreshProfile() {
            const { data } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
            if (data) {
                document.getElementById('welcome-msg').textContent = `Hola, ${data.full_name}`;
                renderAvatar(document.getElementById('avatar-display'), data.avatar_url);
            }
        }

        function renderAvatar(container, url) {
            if (url && (url.startsWith('http') || url.startsWith('data:image'))) {
                container.innerHTML = `<img src="${url}" alt="Avatar" class="w-full h-full object-cover rounded-full">`;
            } else {
                container.innerHTML = `<span class="text-2xl">${url || 'üë§'}</span>`;
            }
        }

        window.openAvatarModal = async () => {
            const grid = document.getElementById('avatar-grid');
            const modal = document.getElementById('avatar-modal');
            
            grid.innerHTML = '<div class="col-span-3 text-yellow-400 animate-pulse text-sm">Escaneando b√≥veda...</div>';
            modal.classList.remove('hidden');

            let avatarsToShow = [];
            let loadedFromList = false;

            try {
                const { data: files, error } = await supabase
                    .storage
                    .from('posters')
                    .list('presets', { limit: 100, sortBy: { column: 'name', order: 'asc' } });

                if (error) throw error;

                if (files && files.length > 0) {
                    const validFiles = files.filter(f => f.name !== '.emptyFolderPlaceholder' && f.metadata);
                    
                    if(validFiles.length > 0) {
                        avatarsToShow = validFiles.map(file => {
                            const { data } = supabase.storage.from('posters').getPublicUrl(`presets/${file.name}`);
                            return data.publicUrl;
                        });
                        loadedFromList = true;
                    }
                }
            } catch (err) {
                console.warn("Fallo lectura autom√°tica (usando respaldo):", err);
            }

            if (!loadedFromList || avatarsToShow.length === 0) {
                console.log("Activando Plan B: Usando lista de respaldo conocida.");
                const manualList = ['1.png', '2.0.png', '3.png', '4.png', '5.png', '6.png', '7.png', '8.png'];
                
                avatarsToShow = manualList.map(name => {
                    const { data } = supabase.storage.from('posters').getPublicUrl(`presets/${name}`);
                    return data.publicUrl;
                });
            }

            const emojis = ['‚òÉÔ∏è',];
            avatarsToShow = [...avatarsToShow, ...emojis];

            grid.innerHTML = '';
            avatarsToShow.forEach(opt => {
                const div = document.createElement('div');
                div.className = "avatar-gallery-item w-20 h-20 rounded-full bg-white/10 cursor-pointer flex items-center justify-center border border-white/20 overflow-hidden shrink-0";
                div.onclick = () => saveAvatar(opt);
                renderAvatar(div, opt);
                grid.appendChild(div);
            });
        }

        window.saveAvatar = async (value) => {
            await supabase.from('profiles').update({ avatar_url: value }).eq('id', currentUser.id);
            document.getElementById('avatar-modal').classList.add('hidden');
            refreshProfile();
        }

        window.uploadCustomAvatar = async () => {
            const fileInput = document.getElementById('custom-avatar-input');
            const file = fileInput.files[0];
            const msg = document.getElementById('avatar-upload-msg');
            if(!file) return;
            msg.textContent = "Subiendo...";
            try {
                const path = `avatars/${currentUser.id}-${Date.now()}.${file.name.split('.').pop()}`;
                const { error: upErr } = await supabase.storage.from('posters').upload(path, file);
                if (upErr) throw upErr;
                const { data: { publicUrl } } = supabase.storage.from('posters').getPublicUrl(path);
                await saveAvatar(publicUrl);
                msg.textContent = "";
            } catch (err) { console.error(err); msg.textContent = "Error al subir"; }
        }

        window.logout = async () => { await supabase.auth.signOut(); window.location.reload(); }

        async function loadCalendar() {
            const simulatedDate = 9; 
            const grid = document.getElementById('calendar-grid');
            const { data: days, error } = await supabase.from('calendar_days').select('*, m1:movies!movie_a_id(*), m2:movies!movie_b_id(*), vote:votes(*)').order('day_number');
            if(error) return;

            grid.innerHTML = '';
            const daysMap = {}; days.forEach(d => daysMap[d.day_number] = d);

            for (let i = 1; i <= 31; i++) {
                const dayData = daysMap[i];
                const cell = document.createElement('div');
                let contentHTML = "", clickHandler = null, className = "calendar-cell ";

                if (dayData) {
                    const isReady = dayData.is_active || (dayData.m1 && dayData.m2);
                    const isDateAllowed = i <= simulatedDate;
                    const isVoteableDay = i <= 24;
                    const isOpen = isReady && isDateAllowed && isVoteableDay;
                    const hasDuel = dayData.m1 && dayData.m2;
                    const votes = dayData.vote || [];
                    const myVote = votes.find(v => v.user_id === currentUser.id);
                    
                    let winnerImg = null;
                    if(votes.length > 0 && hasDuel) {
                        const counts = {}; votes.forEach(v => counts[v.movie_id] = (counts[v.movie_id] || 0) + 1);
                        if((counts[dayData.m1.id]||0) >= (counts[dayData.m2.id]||0)) winnerImg = dayData.m1.image_url;
                        else winnerImg = dayData.m2.image_url;
                    }

                    if (i === 25) {
                        className += "border border-yellow-500/50 bg-yellow-500/10 shadow-[0_0_15px_rgba(251,191,36,0.3)]";
                        contentHTML = `<div class="text-center"><span class="text-3xl md:text-5xl drop-shadow-md">üéÑ</span><h3 class="text-xs md:text-lg font-bold mt-1 christmas-font text-yellow-400 leading-none">¬°FELIZ<br>NAVIDAD!</h3></div>`;
                    } else if (myVote && winnerImg) {
                        className = `aspect-square flip-container`;
                        contentHTML = `
                            <div class="flip-inner">
                                <div class="flip-front" style="background-image: url('${winnerImg}'); border: 2px solid #fbbf24;"><div class="absolute bottom-0 w-full bg-black/70 text-white text-xs text-center py-1">GANADORA</div></div>
                                <div class="flip-back"><span class="text-4xl font-mono">${i}</span><div class="mt-1 text-indigo-900 text-2xl"><i class="fas fa-check-circle"></i></div></div>
                            </div>`;
                        cell.onclick = () => openDuel(dayData, myVote);
                    } else if (isOpen) {
                        className += "active-day";
                        contentHTML = `<span class="text-3xl md:text-4xl font-bold text-white font-mono">${i}</span><div class="mt-1 text-base md:text-lg animate-pulse text-yellow-400">‚ö°</div>`;
                        if (hasDuel) clickHandler = () => openDuel(dayData, myVote);
                    } else {
                        className += "locked-day";
                        contentHTML = `<span class="text-2xl md:text-3xl font-bold text-gray-500 font-mono">${i}</span><i class="fas fa-lock mt-1 text-gray-600 text-xs md:text-sm"></i>`;
                    }
                } else {
                    className += "opacity-20 bg-white/5 border-transparent";
                    contentHTML = `<span class="text-2xl font-bold text-gray-600 font-mono">${i}</span>`;
                }
                cell.className = className; cell.innerHTML = contentHTML;
                if (clickHandler) cell.onclick = clickHandler;
                grid.appendChild(cell);
            }
        }

        let currentDayData = null;
        function openDuel(day, myVote) {
            currentDayData = day;
            document.getElementById('duel-day-number').textContent = day.day_number;
            document.getElementById('img-a').src = day.m1.image_url;
            document.getElementById('title-a').textContent = day.m1.title;
            document.getElementById('img-b').src = day.m2.image_url;
            document.getElementById('title-b').textContent = day.m2.title;
            
            const viewAlready = document.getElementById('view-already-voted');
            const viewOptions = document.getElementById('view-voting-options');
            const msg = document.getElementById('vote-message'); msg.textContent = "";
            
            const contA = document.getElementById('movie-a-container');
            const contB = document.getElementById('movie-b-container');
            
            // Limpieza de clases anteriores para evitar conflictos
            const baseClasses = "cursor-pointer group relative p-4 rounded-2xl bg-black/40 hover:bg-indigo-900/40 transition border border-white/5 hover:border-yellow-400/50 movie-card-container";
            contA.className = baseClasses;
            contB.className = baseClasses;

            contA.onclick = () => voteFor('A'); contB.onclick = () => voteFor('B');

            if (myVote) {
                viewAlready.classList.remove('hidden');
                viewOptions.classList.add('hidden');
                if(myVote.movie_id === day.m1.id) { 
                    contA.className += " ring-2 ring-green-500 bg-green-900/20"; 
                    contB.className += " opacity-40 grayscale"; 
                } else { 
                    contB.className += " ring-2 ring-green-500 bg-green-900/20"; 
                    contA.className += " opacity-40 grayscale"; 
                }
            } else {
                viewAlready.classList.add('hidden');
                viewOptions.classList.remove('hidden');
                msg.textContent = "¬°Toca tu favorita!";
            }
            document.getElementById('duel-modal').classList.remove('hidden');
        }

        window.showVotingOptions = () => { document.getElementById('view-already-voted').classList.add('hidden'); document.getElementById('view-voting-options').classList.remove('hidden'); }
        window.closeDuel = () => document.getElementById('duel-modal').classList.add('hidden');

        window.voteFor = async (option) => {
            const movId = option === 'A' ? currentDayData.m1.id : currentDayData.m2.id;
            const msgEl = document.getElementById('vote-message');
            msgEl.textContent = "Guardando voto..."; msgEl.className = "mt-8 font-bold text-xl h-8 text-center text-yellow-400 animate-pulse";
            try {
                const { error } = await supabase.from('votes').upsert({ day_number: currentDayData.day_number, user_id: currentUser.id, movie_id: movId }, { onConflict: 'day_number, user_id' });
                if(error) throw error;
                msgEl.textContent = "¬°Voto Registrado! üé¨"; msgEl.className = "mt-8 font-bold text-xl h-8 text-center text-green-400";
                setTimeout(() => { closeDuel(); loadCalendar(); }, 800);
            } catch (err) { console.error(err); msgEl.textContent = "Error: " + err.message; msgEl.className = "mt-8 font-bold text-xl h-8 text-center text-red-500"; }
        }

        window.showSection = (id) => { document.getElementById('section-calendar').classList.toggle('hidden', id !== 'calendar'); document.getElementById('section-upload').classList.toggle('hidden', id !== 'upload'); if(id === 'upload') loadUploadedMovies(); }

        async function loadUploadedMovies() {
            const container = document.getElementById('carousel-track');
            const { data: movies, error } = await supabase.from('movies').select('title, image_url').order('created_at', { ascending: false });
            if (error || !movies.length) { container.innerHTML = '<p class="text-gray-500">Sin pel√≠culas a√∫n.</p>'; return; }
            const displayMovies = [...movies, ...movies];
            container.innerHTML = '';
            displayMovies.forEach(movie => {
                const div = document.createElement('div'); div.className = "movie-card-preview w-40";
                div.innerHTML = `<img src="${movie.image_url}" alt="${movie.title}">`; container.appendChild(div);
            });
        }

        document.getElementById('upload-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = document.getElementById('movie-file').files[0];
            const title = document.getElementById('movie-title').value.trim();
            const msg = document.getElementById('upload-msg');
            if(!file) { alert("Falta foto"); return; }
            msg.textContent = "Verificando..."; msg.className = "text-center text-sm font-bold text-yellow-500";
            try {
                const { data: existing } = await supabase.from('movies').select('id').ilike('title', title).single();
                if (existing) throw new Error("¬°Esa pel√≠cula ya est√° en la bolsa!");
                msg.textContent = "Subiendo cartel...";
                const path = `${currentUser.id}-${Date.now()}.${file.name.split('.').pop()}`;
                const { error: upErr } = await supabase.storage.from('posters').upload(path, file);
                if (upErr) throw upErr;
                const { data: { publicUrl } } = supabase.storage.from('posters').getPublicUrl(path);
                const { error: dbErr } = await supabase.from('movies').insert([{ title, image_url: publicUrl, user_id: currentUser.id }]);
                if (dbErr) throw dbErr;
                msg.textContent = "¬°Listo! üé¨"; msg.className = "text-center text-sm font-bold text-green-400";
                document.getElementById('upload-form').reset(); loadUploadedMovies(); 
            } catch (err) { msg.textContent = err.message; msg.className = "text-center text-sm font-bold text-red-400"; }
        });

        function createSnow() {
            const c = document.getElementById('snow-container');
            for(let i=0; i<40; i++) {
                const d = document.createElement('div'); d.className='snowflake'; d.innerHTML='‚Ä¢';
                d.style.left = Math.random()*100+'vw'; d.style.fontSize = (Math.random()*10+10)+'px';
                d.style.animationDuration = (Math.random()*5+5)+'s'; d.style.animationDelay = Math.random()*5+'s'; c.appendChild(d);
            }
        }
    </script>
</body>
</html>